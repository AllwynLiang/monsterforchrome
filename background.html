<html>
<head>
<script type="text/javascript" src="jquery-1.3.2.min.js"></script>
<script type="text/javascript" src="mst.lab.js"></script>
<script>
function start(){
	chrome.extension.onConnect.addListener(function(port) {
		var curtab = chrome.tabs.getSelected(null, function(tab){
			port.postMessage({action: "load", curTab: tab});
		});
		console.assert(port.name == "monster_lt");
		
		chrome.browserAction.onClicked.addListener(function(tab) {
			port.postMessage({action: "click", tab: tab});
		});
	});
}

chrome.extension.onRequest.addListener(
  function (request, sender, sendResponse) {
      if (request.action == 'all') {
          if (request.cssArr) {
              mstBg.cssUrl = request.cssArr;
              sendResponse({ arr1: mstBg.cssUrl });
          }
          if (request.jsArr) {
              mstBg.jsUrl = request.jsArr;
              sendResponse({ arr1: mstBg.jsUrl });
          }
      } else if (request.action == 'single') {
          $.ajax({
              url: request.sUrl,
              type: "get",
              complete: function (rsp, textStatus) {
                  if (textStatus == 'success' && rsp.status == 200) {
                      var char, len, mdt, hall;
                      try { char = rsp.getResponseHeader('Content-Type'); } catch (e) { }
                      try { len = rsp.getResponseHeader('Content-Length'); } catch (e) { }
                      try { mdt = rsp.getResponseHeader('Last-Modified'); } catch (e) { }
                      try { hall = rsp.getAllResponseHeaders(); } catch (e) { }
                      sendResponse({ txt: rsp.responseText, chr: char, size: Number(len), dt: mdt, ha: hall, idx: request.idx, obj: rsp });
                  } else {
                      sendResponse({ txt: null, obj: rsp, idx: request.idx });
                  }
              }
          });

      } else if (request.action == 'img') {
          $.ajax({
              url: request.sUrl,
              type: "get",
              complete: function (rsp, textStatus) {
                  if (textStatus == 'success') {
                      var char = rsp.getResponseHeader('Content-Type');
                      var len = rsp.getResponseHeader('Content-Length');
                      var mdt = rsp.getResponseHeader('Last-Modified');
                      var hall = rsp.getAllResponseHeaders();
                      sendResponse({ url: request.sUrl, chr: char, size: Number(len), dt: mdt, ha: hall, idx: request.idx });
                  }
              }
          });

      } else if (request.action == 'static') {
          $.ajax({
              url: request.sUrl,
              type: "get",
              complete: function (rsp, textStatus) {
                  if (textStatus == 'success' && rsp.status == 200) {
                      var char = rsp.getResponseHeader('Content-Type');
                      var len = rsp.getResponseHeader('Content-Length');
                      var mdt = rsp.getResponseHeader('Last-Modified') || rsp.getResponseHeader('Date');
                      var hall = rsp.getAllResponseHeaders();
                      sendResponse({ txt: rsp.responseText,url: request.sUrl, chr: char, size: Number(len), dt: mdt, ha: hall, idx: request.idx });
                  } else {
                      sendResponse({ err: true, url: request.sUrl, obj: rsp, idx: request.idx });
                  }
              }
          });
      } else if (request.action == 'isEnable') {
          sendResponse({ isEnable: isOk });
      } else if (request.action == 'disable') {
          isOk = false;
          sendResponse({ isEnable: false });
      } else if (request.action == 'getLocalStorage') {
          sendResponse({ val: localStorage[request.name] });
      } else if (request.action == 'viewOption') {
          chrome.tabs.getSelected(null, function (tab) { //设置选项
              chrome.tabs.create({ url: chrome.extension.getURL('options.html' + ((request.param) ? '?default' : '')), index: tab.index + 1 });
          });
      } else if (request.action == 'clearConfig') {
          clearConfig();
          sendResponse({ val: '清除配置成功 ^^' });
      }
  })
</script>
</head>
<body onload="start()">
</body>
</html>